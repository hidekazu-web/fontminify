# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際のClaude Code (claude.ai/code) へのガイダンスを提供します。

## プロジェクト概要

FontMinifyは、フォントのサブセット化と最適化を行うmacOSデスクトップアプリケーションです。Electron + React + TypeScriptで構築され、インテリジェントな文字サブセット化により日本語フォントのファイルサイズを90%以上削減します。

## アーキテクチャ概要

### プロセスアーキテクチャ
- **メインプロセス** (`src/main/`): ネイティブOS操作、ファイルシステム操作、フォント処理を扱うElectronメインプロセス
- **レンダラープロセス** (`src/renderer/`): 厳格なセキュリティ分離されたChromium上で動作するReactベースのUI
- **IPC通信**: 定義されたチャンネルを使用したプロセス間の型安全な双方向通信

### コアモジュール
- **フォント処理** (`src/lib/subset/`): subset-fontライブラリを使用したフォント解析とサブセット化
- **文字プリセット** (`src/lib/presets/`): 日本語テキスト用の事前定義文字セット（最小、標準、JISレベル）
- **状態管理**: レンダラー状態にZustand、プロセス間同期にIPC

## 開発コマンド

```bash
# 依存関係のインストール
npm install

# ホットリロード付き開発モード
npm run dev

# 型チェックの実行
npm run typecheck

# リンティングの実行
npm run lint

# テストの実行
npm test
npm run test:unit       # 単体テストのみ
npm run test:e2e        # E2Eテストのみ

# プロダクションビルド
npm run build

# macOS用パッケージング
npm run dist:mac        # DMGインストーラーを作成
```

## IPC通信パターン

メインプロセスとレンダラープロセス間の全ての通信は型付きチャンネルを使用:

```typescript
// メインプロセスのハンドラー
ipcMain.handle(IPCChannel.ANALYZE_FONT, async (event, filePath: string) => {
  return await analyzeFont(filePath);
});

// レンダラープロセスでの使用
const fontInfo = await ipcRenderer.invoke(IPCChannel.ANALYZE_FONT, filePath);
```

## フォント処理パイプライン

1. **ファイル検証**: フォーマット（TTF/OTF/WOFF/WOFF2）と整合性チェック
2. **フォント解析**: メタデータ、グリフ数、文字範囲の抽出
3. **文字選択**: プリセットまたはカスタム文字セットの適用
4. **サブセット化**: subset-fontを使用して選択したグリフのみを抽出
5. **最適化**: WOFF2での圧縮、未使用機能の削除
6. **出力**: プログレス追跡付きで保存

## セキュリティ考慮事項

- コンテキスト分離がデフォルトで有効
- レンダラーでのNode統合無効化
- 全てのファイル操作はメインプロセス経由
- 全IPCコールの入力検証
- プロダクション用CSPヘッダー設定

## テスト戦略

- **単体テスト**: 個別関数の分離テスト（Vitest）
- **統合テスト**: IPC通信とフォント処理のテスト
- **E2Eテスト**: 実際のフォントファイルを使用した完全なユーザーワークフローのテスト

## パフォーマンス目標

- 10MBフォント処理: 10秒以内
- メモリ使用量: 最大300MB
- UIレスポンス: ドラッグ&ドロップ中60fps

## エラーハンドリング

全てのエラーは型付けされ、復旧提案を含む:

```typescript
throw new AppError({
  type: ErrorType.CORRUPT_FONT,
  message: 'フォントファイルが破損しています',
  recoverable: false
});
```

## プロジェクトミッション

**このプロジェクトはFontMinifyアプリケーションの新規開発です。**
日本語フォントファイルのサブセット化を簡単に行えるmacOSデスクトップアプリケーションを実装する必要があります。

### 主要な実装要件
- ドラッグ&ドロップでフォントファイルを受け付ける
- 複数のプリセット文字セット（最小、基本、標準、JIS第1水準）を提供
- カスタム文字セットの指定機能
- リアルタイムでファイルサイズ削減率を表示
- WOFF2形式での最適化出力

### 技術要件の詳細
- **フォント形式対応**: TTF, OTF, WOFF, WOFF2
- **文字セットプリセット**:
  - 最小セット: ひらがな・カタカナ・英数字・基本記号（約200文字）
  - 基本セット: 上記＋教育漢字（約1,000文字）
  - 標準セット: 上記＋常用漢字（約2,100文字）
  - JIS第1水準: 約3,000文字
- **処理機能**: カーニング、リガチャ、ヒンティング情報の保持/削除選択

### UI実装の重要ポイント
- macOSネイティブUIガイドライン準拠
- ダークモード対応
- Retina対応
- 処理中のプログレス表示とキャンセル機能

## タスク管理ガイドライン

**重要**: タスクを実行する際は、必ず以下の手順に従ってください：

1. **タスク開始前**: 該当するタスクIDを確認し、TodoWriteツールでステータスを`in_progress`に変更
2. **タスク完了後**: 
   - TodoWriteツールでステータスを`completed`に変更
   - 下記のタスクリストの該当項目にチェック（[x]）を付ける
   - 必要に応じて次のタスクを開始
3. **定期的な確認**: 各作業セッションの開始時に進捗状況を確認

## 全タスクリスト（70項目）

### 🔧 プロジェクト初期設定（1-7）
- [x] 1. プロジェクト初期設定
- [x] 2. Electron + React + TypeScript環境構築
- [x] 3. プロジェクトディレクトリ構造の作成
- [x] 4. package.json作成と依存関係インストール
- [x] 5. TypeScript設定（tsconfig.json）
- [x] 6. ESLint/Prettier設定
- [x] 7. Viteビルド設定

### 💻 Electronメインプロセス（8-10）
- [x] 8. Electronメインプロセス実装
- [x] 9. IPC通信チャンネル定義
- [x] 10. メニューバー設定

### 🎨 UI基本構造（11-17）
- [x] 11. React基本構造セットアップ
- [x] 12. Tailwind CSS設定
- [x] 13. ドラッグ&ドロップコンポーネント実装
- [x] 14. フォント情報表示コンポーネント実装
- [x] 15. 文字セット選択UIコンポーネント実装
- [x] 16. プログレス表示コンポーネント実装
- [x] 17. Zustand状態管理セットアップ

### 📝 フォント処理機能（18-24）
- [x] 18. フォントファイル検証機能実装
- [x] 19. フォント解析機能実装（fontkit統合）
- [x] 20. 文字セットプリセット定義
- [x] 21. subset-fontライブラリ統合
- [x] 22. サブセット化処理実装
- [x] 23. WOFF2圧縮機能実装
- [x] 24. カスタム文字セット入力機能

### 💾 ファイル操作・エラー処理（25-27）
- [x] 25. ファイル保存ダイアログ実装
- [x] 26. エラーハンドリング実装
- [x] 27. プログレス更新とキャンセル機能

### 🎯 UI詳細・最適化（28-29）
- [x] 28. ダークモード対応
- [x] 29. Retina対応アイコン作成

### 🧪 基本テスト（30-31）
- [x] 30. 単体テスト実装（Vitest）
- [x] 31. E2Eテスト実装

### 📦 ビルド・配布（32-37）
- [x] 32. electron-builder設定
- [x] 33. DMGパッケージング設定
- [x] 34. コード署名準備
- [x] 35. 自動アップデート機能実装
- [x] 36. README.md作成
- [x] 37. アプリケーションアイコン作成

### 🔒 最終調整（38-40）
- [x] 38. セキュリティ設定（CSP、コンテキスト分離）
- [x] 39. メモリ使用量最適化
- [x] 40. 最終動作確認とバグ修正

### 🧪 詳細テスト項目（41-70）

#### 初期設定・環境テスト（41-43）
- [x] 41. プロジェクト初期設定のテスト（npm install確認）
- [x] 42. Electron起動テスト（メインウィンドウ表示確認）
- [x] 43. IPC通信テスト（メイン・レンダラー間通信）

#### UI機能テスト（44-52）
- [x] 44. ドラッグ&ドロップ機能テスト（複数ファイル、無効ファイル）
- [x] 45. フォントファイル検証テスト（各フォーマット、破損ファイル）
- [x] 46. フォント解析テスト（メタデータ抽出精度）
- [x] 47. 文字セットプリセットテスト（文字数確認）
- [x] 48. サブセット化処理テスト（出力ファイル検証）
- [x] 49. WOFF2圧縮テスト（圧縮率確認）
- [x] 50. カスタム文字セットテスト（重複文字、特殊文字）
- [x] 51. プログレス表示テスト（進捗率の精度）
- [x] 52. キャンセル機能テスト（処理中断の確実性）

#### エラー・異常系テスト（53-55）
- [x] 53. エラーハンドリングテスト（全エラータイプ）
- [x] 54. ファイル保存テスト（権限エラー、容量不足）
- [x] 55. メモリリークテスト（大量ファイル処理）

#### パフォーマンステスト（56-57）
- [x] 56. パフォーマンステスト（10MBフォント処理時間）
- [x] 57. UI応答性テスト（60fps維持確認）

#### UI詳細テスト（58-60）
- [ ] 58. ダークモードテスト（システム設定追従）
- [ ] 59. Retina対応テスト（高解像度表示確認）
- [x] 60. セキュリティテスト（CSP違反、Node統合無効化確認）

#### 特殊ケーステスト（61-64）
- [x] 61. 日本語フォント特化テスト（NotoSans、游ゴシック等）
- [x] 62. 可変フォントテスト（Variable Font対応）
- [x] 63. カラー絵文字フォントテスト
- [x] 64. 複数ファイル同時処理テスト

#### ビルド・配布テスト（65-68）
- [x] 65. DMGインストーラーテスト（インストール・アンインストール）
- [x] 66. コード署名テスト（Gatekeeper警告確認）
- [x] 67. 自動アップデートテスト（更新通知・適用）
- [x] 68. macOS各バージョン互換性テスト（Big Sur以降）

#### 総合テスト（69-70）
- [x] 69. 統合テスト（完全なユーザーワークフロー）
- [x] 70. 最終受け入れテスト（要件定義との照合）

## 進捗サマリー
- **完了**: 68/70 (97.1%)
- **進行中**: 0
- **未着手**: 2

### 完了したタスク（68項目）
1. プロジェクト初期設定
2. Electron + React + TypeScript環境構築
3. プロジェクトディレクトリ構造の作成
4. package.json作成と依存関係インストール
5. TypeScript設定（tsconfig.json）
6. ESLint/Prettier設定
7. Viteビルド設定
8. Electronメインプロセス実装
9. IPC通信チャンネル定義
10. メニューバー設定
11. React基本構造セットアップ
12. Tailwind CSS設定
13. ドラッグ&ドロップコンポーネント実装
14. フォント情報表示コンポーネント実装
15. 文字セット選択UIコンポーネント実装
17. Zustand状態管理セットアップ
18. フォントファイル検証機能実装
19. フォント解析機能実装（fontkit統合）
20. 文字セットプリセット定義
21. subset-fontライブラリ統合
22. サブセット化処理実装
23. WOFF2圧縮機能実装
24. カスタム文字セット入力機能
25. ファイル保存ダイアログ実装
26. エラーハンドリング実装
27. プログレス更新とキャンセル機能
28. ダークモード対応
29. Retina対応アイコン作成
30. 単体テスト実装（Vitest）
31. E2Eテスト実装
32. electron-builder設定
33. DMGパッケージング設定
34. コード署名準備
35. 自動アップデート機能実装
36. README.md作成
37. アプリケーションアイコン作成
38. セキュリティ設定（CSP、コンテキスト分離）
39. メモリ使用量最適化
40. 最終動作確認とバグ修正
41. プロジェクト初期設定のテスト（npm install確認）
42. Electron起動テスト（メインウィンドウ表示確認）
43. IPC通信テスト（メイン・レンダラー間通信）
44. ドラッグ&ドロップ機能テスト
45. フォントファイル検証テスト
46. フォント解析テスト（メタデータ抽出精度）
47. 文字セットプリセットテスト（文字数確認）
48. サブセット化処理テスト（出力ファイル検証）
49. WOFF2圧縮テスト（圧縮率確認）
50. カスタム文字セットテスト（重複文字、特殊文字）
51. プログレス表示テスト（進捗率の精度）
52. キャンセル機能テスト（処理中断の確実性）
53. エラーハンドリングテスト（全エラータイプ）
54. ファイル保存テスト（権限エラー、容量不足）
55. メモリリークテスト（大量ファイル処理）
56. パフォーマンステスト（10MBフォント処理時間）
57. UI応答性テスト（60fps維持確認）
60. セキュリティテスト（CSP違反、Node統合無効化確認）
61. 日本語フォント特化テスト（NotoSans、游ゴシック等）
62. 可変フォントテスト（Variable Font対応）
63. カラー絵文字フォントテスト
64. 複数ファイル同時処理テスト
65. DMGインストーラーテスト（インストール・アンインストール）
66. コード署名テスト（Gatekeeper警告確認）
67. 自動アップデートテスト（更新通知・適用）
68. macOS各バージョン互換性テスト（Big Sur以降）
69. 統合テスト（完全なユーザーワークフロー）
70. 最終受け入れテスト（要件定義との照合）

### 現在進行中
なし

### 残りのタスク（2項目）
- 58. ダークモードテスト（システム設定追従）
- 59. Retina対応テスト（高解像度表示確認）

## 🎉 高優先度タスク完了！

**全ての高優先度タスクが完了しました（11/11 = 100%）**
- ✅ フォント解析テスト（メタデータ抽出精度）
- ✅ 文字セットプリセットテスト（文字数確認）
- ✅ サブセット化処理テスト（出力ファイル検証）
- ✅ WOFF2圧縮テスト（圧縮率確認）
- ✅ カスタム文字セットテスト（重複文字、特殊文字）
- ✅ プログレス表示テスト（進捗率の精度）
- ✅ キャンセル機能テスト（処理中断の確実性）
- ✅ 日本語フォント特化テスト（NotoSans、游ゴシック等）
- ✅ 複数ファイル同時処理テスト
- ✅ 統合テスト（完全なユーザーワークフロー）
- ✅ 最終受け入れテスト（要件定義との照合）

## 🎯 全70タスク完了率: 68/70 (97.1%)

**FontMinifyプロジェクトはほぼ完了しており、残りは2つの低優先度UIテスト項目のみです。**

## 🏆 プロジェクト完了度
- **コア機能**: 100%完了 ✅
- **テスト**: 97.1%完了 ✅
- **ビルド・配布**: 100%完了 ✅
- **高優先度タスク**: 100%完了 ✅
- **中優先度タスク**: 100%完了 ✅

**残り2項目は低優先度のUIテストのみで、アプリケーションは完全に機能します。**

最終更新日: 2025-07-26