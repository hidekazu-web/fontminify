# FontMinify Web版 仕様書

作成日: 2024-12-14

## 1. 概要

### 1.1 目的

FontMinify Web版は、日本語フォントのサブセット化・最適化をブラウザ上で完結させるWebアプリケーションである。既存のElectronデスクトップアプリの機能をWebに移植し、インストール不要で利用可能にする。

### 1.2 アプローチ

**完全クライアントサイド処理**を採用する。

- 全てのフォント処理をブラウザ内で実行
- サーバーへのフォントアップロード不要
- 静的ホスティングで運用可能

### 1.3 対象ユーザー

- Webデザイナー・フロントエンドエンジニア
- フォントファイルサイズを削減したいユーザー
- macOS以外のOS（Windows/Linux）ユーザー

---

## 2. 機能要件

### 2.1 フォント入力

| 機能 | 説明 | 優先度 |
|-----|------|--------|
| ドラッグ&ドロップ | フォントファイルをドロップゾーンにドラッグして追加 | 必須 |
| ファイル選択ダイアログ | クリックでファイル選択ダイアログを開く | 必須 |
| 複数ファイル対応 | 複数フォントの同時選択・処理 | 必須 |
| 対応フォーマット | TTF, OTF, WOFF, WOFF2 | 必須 |

### 2.2 フォント解析

| 機能 | 説明 | 優先度 |
|-----|------|--------|
| メタデータ表示 | フォント名、バージョン、作成者 | 必須 |
| グリフ数表示 | 収録グリフ数の表示 | 必須 |
| ファイルサイズ表示 | 元ファイルサイズの表示 | 必須 |
| バリアブルフォント検出 | 軸情報の表示・制御 | 必須 |
| プレビュー | フォントのサンプル表示 | 任意 |

### 2.3 文字セット選択

| 機能 | 説明 | 優先度 |
|-----|------|--------|
| プリセット選択 | 最小/基本/標準/JIS第1水準 | 必須 |
| カスタム文字入力 | ユーザー定義の文字セット | 必須 |
| 文字数カウント | 選択中の文字数表示 | 必須 |
| プリセット詳細表示 | 各プリセットの内容説明 | 任意 |

**プリセット仕様**（Electron版と同一）:

| プリセット | ID | 文字数 | 内容 |
|-----------|-----|--------|------|
| 最小 | minimal | ~200 | ひらがな・カタカナ・英数字・基本記号 |
| 基本 | basic | ~1,000 | 上記 + 教育漢字 |
| 標準 | standard | ~2,100 | 上記 + 常用漢字 |
| JIS第1水準 | joyo-jis1 | ~3,000 | JIS X 0208 第1水準漢字 |

### 2.4 サブセット化処理

| 機能 | 説明 | 優先度 |
|-----|------|--------|
| サブセット化 | 選択文字のみを含むフォント生成 | 必須 |
| WOFF2圧縮 | WOFF2形式での出力 | 必須 |
| 出力形式選択 | TTF/OTF/WOFF/WOFF2 | 必須 |
| バリアブル軸固定 | 軸を特定値に固定して出力 | 必須 |
| 進捗表示 | 処理進捗のリアルタイム表示 | 必須 |
| キャンセル機能 | 処理中断 | 必須 |

### 2.5 ファイル出力

| 機能 | 説明 | 優先度 |
|-----|------|--------|
| ダウンロード | 処理済みフォントのダウンロード | 必須 |
| ファイル名自動生成 | 元ファイル名 + サフィックス | 必須 |
| サイズ削減率表示 | 元サイズとの比較 | 必須 |
| 一括ダウンロード | 複数ファイルのZIP化 | 任意 |

### 2.6 UI/UX

| 機能 | 説明 | 優先度 |
|-----|------|--------|
| ダークモード | ダーク/ライトテーマ切替 | 任意 |
| レスポンシブ | モバイル対応レイアウト | 任意 |
| エラー表示 | わかりやすいエラーメッセージ | 必須 |
| 処理履歴 | 直近の処理結果一覧 | 任意 |

---

## 3. 非機能要件

### 3.1 パフォーマンス

| 項目 | 要件 |
|-----|------|
| 初回ロード | 3秒以内（WASM含む、3G回線除く） |
| フォント処理 | 10MBフォントを30秒以内 |
| UI応答性 | 60fps維持、処理中もUIブロックなし |
| メモリ使用 | 500MB以下（大規模フォント処理時） |

### 3.2 ブラウザ対応

| ブラウザ | 最小バージョン |
|---------|---------------|
| Chrome | 89+ |
| Firefox | 78+ |
| Safari | 15+ |
| Edge | 89+ |

**必須Web API**:
- Web Workers
- WebAssembly
- File API
- Blob API
- ArrayBuffer / Uint8Array

### 3.3 セキュリティ

| 項目 | 要件 |
|-----|------|
| データ送信 | フォントデータをサーバーに送信しない |
| ローカル処理 | 全処理をブラウザ内で完結 |
| HTTPS | 本番環境では必須 |
| CSP | Content Security Policy設定 |

### 3.4 アクセシビリティ

| 項目 | 要件 |
|-----|------|
| キーボード操作 | 全機能をキーボードで操作可能 |
| スクリーンリーダー | ARIA属性の適切な設定 |
| コントラスト | WCAG 2.1 AA準拠 |

---

## 4. 技術仕様

### 4.1 フロントエンド

| 技術 | バージョン | 用途 |
|-----|-----------|------|
| React | 18.x | UIフレームワーク |
| TypeScript | 5.x | 型安全性 |
| Zustand | 4.x | 状態管理 |
| Tailwind CSS | 3.x | スタイリング |
| Vite | 5.x | ビルドツール |

### 4.2 フォント処理

| ライブラリ | 用途 | 備考 |
|-----------|------|------|
| subset-font | サブセット化 | harfbuzzjs (WASM) ベース |
| fontkit | フォント解析 | Uint8Array入力対応 |

### 4.3 Web Worker

フォント処理はWeb Workerで実行し、メインスレッドをブロックしない。

**Worker通信プロトコル**:

```typescript
// メインスレッド → Worker
interface WorkerRequest {
  type: 'analyze' | 'subset' | 'cancel'
  id: string
  payload: AnalyzePayload | SubsetPayload
}

// Worker → メインスレッド
interface WorkerResponse {
  type: 'result' | 'progress' | 'error'
  id: string
  payload: ResultPayload | ProgressPayload | ErrorPayload
}
```

### 4.4 ファイルサイズ目標

| 項目 | 目標サイズ (gzipped) |
|-----|---------------------|
| JavaScript (初期) | 150KB |
| JavaScript (遅延) | 50KB |
| WASM (harfbuzzjs) | 750KB |
| CSS | 30KB |
| **合計** | ~1MB |

---

## 5. 画面仕様

### 5.1 メイン画面

```
+--------------------------------------------------+
|  FontMinify                           [Theme]    |
+--------------------------------------------------+
|                                                  |
|  +--------------------------------------------+  |
|  |                                            |  |
|  |     ドラッグ&ドロップでフォントを追加      |  |
|  |     または クリックして選択                |  |
|  |                                            |  |
|  +--------------------------------------------+  |
|                                                  |
|  [フォント情報パネル]                            |
|  +--------------------------------------------+  |
|  | フォント名: Noto Sans JP                   |  |
|  | グリフ数: 16,000                           |  |
|  | サイズ: 4.2MB                              |  |
|  +--------------------------------------------+  |
|                                                  |
|  [文字セット選択]                                |
|  +--------------------------------------------+  |
|  | ○ 最小 (~200文字)                          |  |
|  | ○ 基本 (~1,000文字)                        |  |
|  | ● 標準 (~2,100文字)  ← デフォルト          |  |
|  | ○ JIS第1水準 (~3,000文字)                  |  |
|  | ○ カスタム [入力欄]                        |  |
|  +--------------------------------------------+  |
|                                                  |
|  [出力オプション]                                |
|  +--------------------------------------------+  |
|  | 出力形式: [WOFF2 ▼]                        |  |
|  +--------------------------------------------+  |
|                                                  |
|  [========処理ボタン========]                    |
|  |     サブセット化して保存                   |  |
|  +--------------------------------------------+  |
|                                                  |
+--------------------------------------------------+
```

### 5.2 処理中画面

```
+--------------------------------------------------+
|  処理中...                                       |
|  +--------------------------------------------+  |
|  | ████████████░░░░░░░░░░░░░  48%             |  |
|  | フォントをサブセット化中...                 |  |
|  +--------------------------------------------+  |
|  |                [キャンセル]                 |  |
|  +--------------------------------------------+  |
+--------------------------------------------------+
```

### 5.3 完了画面

```
+--------------------------------------------------+
|  処理完了                                        |
|  +--------------------------------------------+  |
|  | ✓ NotoSansJP-subset.woff2                  |  |
|  | 元サイズ: 4.2MB → 320KB (92%削減)          |  |
|  +--------------------------------------------+  |
|  |      [ダウンロード]  [新しいフォント]      |  |
|  +--------------------------------------------+  |
+--------------------------------------------------+
```

---

## 6. エラーハンドリング

### 6.1 エラー種別

| エラーコード | メッセージ | 対処 |
|-------------|-----------|------|
| INVALID_FILE | 対応していないファイル形式です | ファイル形式を確認 |
| FILE_TOO_LARGE | ファイルサイズが大きすぎます | 100MB未満を推奨 |
| PARSE_ERROR | フォントの解析に失敗しました | 破損確認 |
| SUBSET_ERROR | サブセット化に失敗しました | 文字セット確認 |
| MEMORY_ERROR | メモリ不足です | ブラウザ再起動 |
| WORKER_ERROR | 処理中にエラーが発生しました | 再試行 |

### 6.2 エラー表示

- トースト通知でエラーを表示
- 詳細情報は展開可能
- 再試行ボタンを提供

---

## 7. 将来拡張（スコープ外）

以下は初期リリースのスコープ外とし、将来の拡張候補とする。

- PWA化（オフライン対応）
- フォントプレビュー機能
- バッチ処理の最適化
- 処理履歴の永続化（IndexedDB）
- ドラッグ&ドロップによるフォルダ対応
- 国際化（i18n）

---

## 8. 制約事項

### 8.1 ブラウザ制限

- **メモリ制限**: ブラウザのメモリ制限により、100MB超のフォントは処理できない場合がある
- **WASM制限**: WebAssembly非対応ブラウザでは動作しない
- **SharedArrayBuffer**: 一部機能は SharedArrayBuffer が必要（COOP/COEP ヘッダー必須）

### 8.2 機能制限

- ファイルシステムへの直接保存は File System Access API 対応ブラウザのみ
- 非対応ブラウザではダウンロードとして提供

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2024-12-14 | 初版作成 |
